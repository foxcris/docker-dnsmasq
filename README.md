# docker-dnsmasq installation

A docker container with dnsmasq installed. 
Features:
* basic configuration is done via environment variables
* advanced configuration is possibles via a custom configuration files
  
## Configuration
 
### Configuration files, log files, business data
The following directories can be loaded from the host to keep the data and configuration files out of the container:

 | PATH in container | Description |
 | ---------------------- | ----------- |
 | /var/log | Default Logging Directory of the container. Logging information can be found in the syslog file.|
 | /etc/dnsmasq.d | Fold for all configuration files for dnsmasq. |
 | /var/lib/misc | Storage folder of the lease file of dnsmasq (if used as dhcp server) |
 
### Environment variables
The following environment variables are available to configure the container on startup.

 | Environment Variable | Description |
 | ---------------------- | ----------- |
 | DOCKER_DNSMASQ_DOMAIN | Specifies DNS domains for the DHCP server. |
 | DOCKER_DNSMASQ_LISTENADDRESS | Only listen on the interface with the specified adresse. |
 | DOCKER_DNSMASQ_INTERFACE | Only listen on the specified interface |
 | DOCKER_DNSMASQ_DHCPRANGE_IPSTART | Start IP adress of the ip range to use for dhcp. All DOCKER_DNSMASQ_DHCPRANGE_\* have to be set to use the dhcp server. |
 | DOCKER_DNSMASQ_DHCPRANGE_IPEND | End IP adress of the ip range to use for dhcp. All DOCKER_DNSMASQ_DHCPRANGE_\* have to be set to use the dhcp server. |
 | DOCKER_DNSMASQ_DHCPRANGE_NETMASK | Netmask to use for dhcp. All DOCKER_DNSMASQ_DHCPRANGE_\* have to be set to use the dhcp server. |
 | DOCKER_DNSMASQ_DHCPRANGE_LEASETIME | Leasetime to use for dhcp assignments. All DOCKER_DNSMASQ_DHCPRANGE_\* have to be set to use the dhcp server. |
 | DOCKER_DNSMASQ_DEBUG | Enable debug options for extended logging of dns and dhcp queries |
 | DOCKER_DNSMASQ_DNSFORWARD | Forwarding DNS Server to be used. |
 | DOCKER_DNSMASQ_DNS_PORT | DNS Port to be used. Set to 0 to disable DNS server. |
 | DOCKER_DNSMASQ_DHCP_GATEWAY | The gateway to advertise with dhcp (option 3) |
 | DOCKER_DNSMASQ_DHCP_DNS | The DNS server to advertise with dhcp (option 6) |
 | DOCKER_DNSMASQ_DHCP_NTP | The NTP server to advertise with dhcp (option 42) |

### Custom configuration file

Just put a normal dnsmasq configuration file in the /etc/dnsmasq.d/ folder. Every file in there is applied. Do _not_ edit /etc/dnsmasq.d/dnsmasq.conf as this file is auto generated by the container!

## Container Tags

 | Tag name | Description |
 | ---------------------- | ----------- |
 | latest | Latest stable version of the container |
 | stable | Latest stable version of the container |
 | dev | latest development version of the container. Do not use in production environments! |

## Usage

### docker-compose

```
version: "3"
services:
  dnsmasq:
    image: foxcris/docker-dnsmasq:dev
    environment:
      - DOCKER_DNSMASQ_DOMAIN=ad.rau.lan
      - DOCKER_DNSMASQ_LISTENADDRESS=10.10.10.1
      - DOCKER_DNSMASQ_DHCPRANGE_IPSTART=10.10.10.50
      - DOCKER_DNSMASQ_DHCPRANGE_IPEND=10.10.10.200
      - DOCKER_DNSMASQ_DHCPRANGE_NETMASK=255.255.255.0
      - DOCKER_DNSMASQ_DHCPRANGE_LEASETIME=30m
      - DOCKER_DNSMASQ_DEBUG=true
      - DOCKER_DNSMASQ_DNS_PORT=0
      - DOCKER_DNSMASQ_DHCP_GATEWAY=10.10.10.1
      - DOCKER_DNSMASQ_DHCP_DNS=10.10.10.1
      - DOCKER_DNSMASQ_DHCP_NTP=10.10.10.1
      - DOCKER_DNSMASQ_INTERFACE=enp0s8
      - DOCKER_DNSMASQ_DNSFORWARD=192.168.3.1
    volumes:
      - ./data/etc/dnsmasq.d:/etc/dnsmasq.d
      - ./data/var/lib/misc:/var/lib/misc
    restart: always
    network_mode: "host"
    cap_add:
      - NET_ADMIN
```

### docker command line

To run the container and store the data and configuration on the local host run the following commands:
1. Create storage directroy for the configuration files, log files and data. Also create a directory to store the necessary script to create the docker container and replace it (if not using eg. watchtower)
```
mkdir /srv/docker/dnsmasq
mkdir /srv/docker-config/dnsmasq
```

2. Create an file to store the configuration of the environment variables
```
touch /srv/docker-config/dnsmasq/env_file
```
DOCKER_DNSMASQ_DOMAIN=ad.rau.lan
DOCKER_DNSMASQ_LISTENADDRESS=10.10.10.1
DOCKER_DNSMASQ_DHCPRANGE_IPSTART=10.10.10.50
DOCKER_DNSMASQ_DHCPRANGE_IPEND=10.10.10.200
DOCKER_DNSMASQ_DHCPRANGE_NETMASK=255.255.255.0
DOCKER_DNSMASQ_DHCPRANGE_LEASETIME=30m
DOCKER_DNSMASQ_DEBUG=true
DOCKER_DNSMASQ_DNS_PORT=0
DOCKER_DNSMASQ_DHCP_GATEWAY=10.10.10.1
DOCKER_DNSMASQ_DHCP_DNS=10.10.10.1
DOCKER_DNSMASQ_DHCP_NTP=10.10.10.1
DOCKER_DNSMASQ_INTERFACE=enp0s8
DOCKER_DNSMASQ_DNSFORWARD=192.168.3.1
```

```

3. Create the docker container and configure the docker networks for the container. I always create a script for that and store it under
```
touch /srv/docker-config/dnsmasq/create.sh
```
Content of create.sh:
```
#!/bin/bash

version=stable

docker pull foxcris/docker-dnsmasq
docker create\
 --restart always\
 --name dnsmasq\
 --volume "/srv/docker/dnsmasq/data/etc/dnsmasq.d:/etc/dnsmasq.d"
 --volume "/srv/docker/dnsmasq/data/var/lib/misc:/var/lib/misc"
 --env-file=/srv/docker-config/dnsmasq/env_file\
 foxcris/docker-dnsmasq:${version}
```

4. Create replace.sh to install/update the container. Store it in
```
touch /srv/docker-config/dnsmasq/replace.sh
```
```
#/bin/bash
docker stop dnsmasq
docker rm dnsmasq
./create.sh
docker start dnsmasq
```
